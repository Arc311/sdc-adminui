/* Caliper.js Backbone plugin v0.0.4 (c) 2013 Coherence Inc (http://caliper.io) */
(function(t,e,n,r,i){"use strict";if(n!==i&&t.Caliper!==i){var o,a={VERSION:"0.0.4"},u=0,s=Date.now||function(){return s()},c=function(t){return t&&t.constructor?t.constructor.__name__:i},l=function(t,e,n){return function(){var r=Array.prototype.slice.call(arguments);if("function"==typeof e){var o=e.apply(this,r);o!==i&&(r=o)}var a=t.apply(this,r);return"function"==typeof n?n.apply(this,[a].concat(r)):a}},p=function(t,e,n,i,o){var a=t[e];if("function"!=typeof a)return a;var u;u="function"==typeof a.extend?a.extend({constructor:l(a,i,o)}):r.extend(l(a,i,o),a);var s="__"+e+"_without_"+n+"__",c="__"+e+"_with_"+n+"__";return t[c]=t[e]=u,t[s]=a,u},f=function(e){o&&0===u&&(t.Caliper.queue.push({name:"backbone.routes.load.complete",start:o,stop:e,identifier:n.history.getFragment(),url:t.location.href}),o=i,u=0)};n.History!==i&&(n.history=n.history||new n.History,"function"==typeof n.history.route&&p(n.history,"route","instrumentation",function(){var e=Array.prototype.slice.call(arguments),r=e[1];return e[1]=function(){u=0,o=s();var e=o,i=r.apply(this,arguments),a=s();return t.Caliper.queue.push({name:"backbone.routes.load.interactive",start:e,stop:a,identifier:n.history.getFragment(),url:t.location.href}),f(a),i},e})),n.View!==i&&p(n,"View","instrumentation",function(){var e,n=c(this);p(this,"render","instrumentation",function(){e=s()},function(r){return t.Caliper.queue.push({name:"backbone.views.render",start:e,stop:s(),identifier:n,url:t.location.href}),r})}),n.Model!==i&&n.Collection!==i&&r.each(["Model","Collection"],function(e){p(n,e,"instrumentation",function(){var n=this,r=c(this),i=e.toLowerCase()+"s";p(n,"sync","instrumentation",function(){var e,n=Array.prototype.slice.call(arguments),o=n[2]||{},a=o.success,c=o.error;return o.success=function(){if(t.Caliper.queue.push({name:"backbone."+i+".sync",start:e,stop:s(),identifier:r,url:t.location.href}),"function"==typeof a){var n=s(),o=a.apply(this,arguments),c=s();return t.Caliper.queue.push({name:"backbone."+i+".sync.callbacks.success",start:n,stop:c,identifier:r,url:t.location.href}),u--,f(c),o}},o.error=function(){if(t.Caliper.queue.push({name:"backbone."+i+".sync.error",start:s(),identifier:r,url:t.location.href}),"function"==typeof c){var e=s(),n=c.apply(this,arguments),o=s();return t.Caliper.queue.push({name:"backbone."+i+".sync.callbacks.error",start:e,stop:o,identifier:r,url:t.location.href}),u--,f(o),n}},u++,e=s(),n})})}),t.Caliper.plugins=t.Caliper.plugins||{},t.Caliper.plugins.Backbone=a}})(window,document,window.Backbone,window._);